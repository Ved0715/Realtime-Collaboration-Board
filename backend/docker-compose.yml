# Docker Compose version (3.8 is widely compatible)
version: '3.8'

# Define services (containers) to run
services:
  # ==========================================
  # FastAPI Backend Service
  # ==========================================
  backend:
    # Build context: current directory (where Dockerfile is)
    build:
      context: .
      dockerfile: Dockerfile

    # Container name (easier to reference than auto-generated name)
    container_name: realtime-backend

    # Port mapping: host:container
    # Access via http://localhost:8000 on your Mac
    ports:
      - "8000:8000"

    # Environment variables
    # These override values in .env file
    environment:
      # Database - using NeonDB cloud (change to postgres service if using local DB)
      - DATABASE_URL=${DATABASE_URL}

      # Redis connection (using service name 'redis' as hostname)
      # Docker Compose creates internal DNS, so 'redis' resolves to redis container IP
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0

      # JWT Secret
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30

      # CORS
      - CORS_ORIGINS=http://localhost:3000,http://localhost:5173

      # App settings
      - DEBUG=True

    # Dependencies: Start redis before backend
    depends_on:
      redis:
        condition: service_healthy

    # Restart policy: always restart if container crashes
    restart: unless-stopped

    # Volume mounting for development (hot-reload)
    # Mounts current directory to /app in container
    # Changes on host immediately reflect in container
    volumes:
      - ./app:/app/app

    # Networks: Connect to custom network
    networks:
      - realtime-network

    # Health check (override Dockerfile healthcheck with custom interval)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================
  # Redis Service (Pub/Sub)
  # ==========================================
  redis:
    # Use official Redis image (alpine = lightweight Linux)
    image: redis:7-alpine

    container_name: realtime-redis-compose

    # Port mapping (access Redis from host via localhost:6379)
    ports:
      - "6379:6379"

    # Command to run with password protection (optional)
    # If you want password: uncomment and set REDIS_PASSWORD in .env
    # command: redis-server --requirepass ${REDIS_PASSWORD}

    # Restart policy
    restart: unless-stopped

    # Volume for Redis data persistence
    # Data survives container restarts/removals
    volumes:
      - redis-data:/data

    networks:
      - realtime-network

    # Health check for Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ==========================================
  # PostgreSQL Service (Optional - Local DB)
  # ==========================================
  # Uncomment if you want local database instead of NeonDB
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: realtime-postgres
  #
  #   environment:
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=postgres
  #     - POSTGRES_DB=realtime_board
  #
  #   ports:
  #     - "5432:5432"
  #
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #
  #   networks:
  #     - realtime-network
  #
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 5s
  #     timeout: 3s
  #     retries: 5

# ==========================================
# Volumes (Persistent Data)
# ==========================================
volumes:
  # Redis data persistence
  redis-data:
    driver: local

  # PostgreSQL data persistence (uncomment if using postgres service)
  # postgres-data:
  #   driver: local

# ==========================================
# Networks
# ==========================================
networks:
  # Custom bridge network for inter-container communication
  realtime-network:
    driver: bridge
